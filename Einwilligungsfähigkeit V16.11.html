<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Einwilligungsfähigkeit – Test & Auto‑Befund (Neon Light)</title>
  <style>
    :root{--bg:#f7f9fc;--ink:#121622;--muted:#5f6b85;--primary:#375dfc;--good:#12b886;--bad:#ff4664;--warn:#e6a700;--good-bg:rgba(18,184,134,.40);--bad-bg:rgba(255,70,100,.40);--neutral-bg:rgba(55,93,252,.08);--radius:16px;--shadow:0 10px 30px rgba(0,0,0,.15);--ring:0 0 0 2px rgba(55,93,252,.18),0 8px 24px rgba(55,93,252,.12)}
    *{box-sizing:border-box}
    html,body{height:100%}
    html{font-size:18px}
    body{margin:0;color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);line-height:1.6}
    body::before{content:"";position:fixed;inset:0;z-index:-1;pointer-events:none;background:radial-gradient(1200px 700px at -10% -10%, rgba(55,93,252,.12), transparent 60%),radial-gradient(900px 600px at 115% 10%, rgba(18,184,134,.10), transparent 55%),url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1600" height="1000"><defs><linearGradient id="g1" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="%23ffffff"/><stop offset="100%" stop-color="%23f5f7ff"/></linearGradient><radialGradient id="blob" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="%23375dfc" stop-opacity=".15"/><stop offset="100%" stop-color="%23375dfc" stop-opacity="0"/></radialGradient></defs><rect width="1600" height="1000" fill="url(%23g1)"/><g opacity="0.7"><circle cx="200" cy="220" r="180" fill="url(%23blob)"/><circle cx="1400" cy="160" r="220" fill="url(%23blob)"/><circle cx="1200" cy="820" r="280" fill="url(%23blob)"/></g><g opacity=".06" stroke="%23121622" stroke-width="1"><path d="M0 120 Q 300 60 600 120 T 1200 120 T 1600 120" fill="none"/><path d="M0 360 Q 300 300 600 360 T 1200 360 T 1600 360" fill="none"/><path d="M0 600 Q 300 540 600 600 T 1200 600 T 1600 600" fill="none"/></g></svg>'),url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/><feColorMatrix type="saturate" values="0"/><feComponentTransfer><feFuncA type="table" tableValues="0 0 .02 .04"/></feComponentTransfer></filter><rect width="200" height="200" filter="url(%23n)"/></svg>');background-attachment:fixed,fixed,fixed,fixed;background-size:cover,cover,1600px 1000px,200px 200px;background-position:center}
    a{color:var(--primary)}.container{max-width:920px;margin:36px auto;padding:0 18px}
    .card{background:var(--neutral-bg);border:1px solid rgba(17,23,41,.06);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px;margin:22px 0;position:relative;backdrop-filter:blur(6px)}
    .neon{transition:box-shadow .25s ease,border-color .25s ease,background-color .25s ease}.neon.pending{box-shadow:0 0 0 2px rgba(255,70,100,.22),0 0 26px rgba(255,70,100,.28);background:var(--bad-bg)}.neon.ready{box-shadow:0 0 0 2px rgba(18,184,134,.22),0 0 26px rgba(18,184,134,.28);background:var(--good-bg)}
    h1{font-size:1.7rem;margin:0 0 8px}h2{font-size:1.2rem;margin:0 0 12px}p.note{margin:.25rem 0 1rem;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr;gap:0}.row{display:grid;grid-template-columns:1fr;gap:14px}
    label{font-weight:600}
    input[type="text"],textarea,input[type="date"],input[type="time"],select{width:100%;padding:12px 14px;border-radius:12px;background:#fff;color:var(--ink);border:1px solid rgba(17,23,41,.12);outline:none;transition:border-color .2s ease,box-shadow .2s ease}
    input[type="text"]:focus,textarea:focus,input[type="date"]:focus,input[type="time"]:focus,select:focus{border-color:rgba(55,93,252,.55);box-shadow:var(--ring)}
    textarea{min-height:160px;resize:vertical}
    .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    button{border:0;border-radius:12px;padding:12px 16px;cursor:pointer;font-weight:700;letter-spacing:.2px}button.primary{background:linear-gradient(180deg,#5f86ff,#3c62ff);color:#fff}button.secondary{background:#fff;color:var(--ink);border:1px solid rgba(17,23,41,.12)}
    .badge{font-size:.85rem;font-weight:800;padding:6px 10px;border-radius:999px;display:inline-block}.ok{background:rgba(18,184,134,.16);color:var(--good);border:1px solid rgba(18,184,134,.45)}.warn{background:rgba(230,167,0,.14);color:var(--warn);border:1px solid rgba(230,167,0,.45)}.bad{background:rgba(255,70,100,.16);color:var(--bad);border:1px solid rgba(255,70,100,.45)}.unknown{background:rgba(55,93,252,.14);color:var(--primary);border:1px solid rgba(55,93,252,.45)}
    .slider-wrap{margin:12px 0}.slider-header{display:flex;justify-content:space-between;align-items:center}.slider-val{font-weight:800;font-variant-numeric:tabular-nums;color:var(--primary)}
    input[type=range]{-webkit-appearance:none;width:100%;background:transparent;height:20px;cursor:pointer}input[type=range]:focus{outline:none}
    input[type=range]::-webkit-slider-runnable-track{height:20px;background:linear-gradient(90deg,rgba(255,70,100,.35),rgba(230,167,0,.35),rgba(18,184,134,.45));border-radius:999px}
    input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;margin-top:0;height:20px;width:20px;border-radius:50%;background:#fff;box-shadow:0 0 0 3px rgba(255,255,255,.7),0 4px 12px rgba(0,0,0,.2);transition:transform .15s ease}
    input[type=range]:active::-webkit-slider-thumb{transform:scale(1.06)}
    input[type=range]::-moz-range-track{height:20px;background:linear-gradient(90deg,rgba(255,70,100,.35),rgba(230,167,0,.35),rgba(18,184,134,.45));border-radius:999px}
    input[type=range]::-moz-range-thumb{height:20px;width:20px;border-radius:50%;background:#fff;box-shadow:0 0 0 3px rgba(255,255,255,.7),0 4px 12px rgba(0,0,0,.2)}
    .ticks{display:flex;justify-content:space-between;font-size:.8rem;color:var(--muted)}.ticks span{width:24%;text-align:center}
    .ticks1{display:block;font-size:.8rem;color:var(--muted)}
    .collapsible {background-color: transparent;color:var(--muted);cursor: pointer;padding: 8px;width: 10%;border: none;text-align: center;outline: none;font-size: 13px;margin-left:90%}
    .active, .collapsible:hover {background-color: #ccc;}
    .content1 {padding: 0 18px;display: none;overflow: hidden;background-color:transparent;border-radius: 15px;}
    .pill{display:inline-flex;align-items:center;gap:8px;background:rgba(55,93,252,.06);border:1px dashed rgba(55,93,252,.3);border-radius:999px;padding:6px 10px;color:var(--ink);font-weight:600}
    .footer{color:var(--muted);font-size:.85rem;margin-top:8px}.signature{margin-top:24px;color:var(--muted);text-align:center;font-size:.9rem;opacity:.9}
    .tests{white-space:pre-wrap;background:#fff;padding:12px;border-radius:12px;border:1px solid rgba(17,23,41,.12)}.friendly{margin-top:10px;padding:10px;border-radius:10px;background:rgba(55,93,252,.08);border:1px solid rgba(55,93,252,.25)}
    .app-footer{color:var(--muted);font-size:.85rem;text-align:center;margin:16px 0 8px;padding:12px 14px;border-radius:12px;border:1px dashed rgba(17,23,41,.18);background:rgba(255,255,255,.7);backdrop-filter:blur(4px)}
    .choices{display:flex;flex-wrap:wrap;gap:8px}.choices.twocol{display:grid;grid-template-columns:1fr 1fr;gap:8px}@media (max-width:700px){.choices.twocol{grid-template-columns:1fr}}
    .choice{position:relative;display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:999px;background:#fff;border:1px solid rgba(17,23,41,.12);cursor:pointer;font-weight:600;color:var(--ink);transition:background-color .15s ease,box-shadow .15s ease,border-color .15s ease}
    .choice::before{content:"";display:inline-block;width:16px;height:16px;border-radius:4px;border:2px solid var(--primary)}.choice input{position:absolute;opacity:0;pointer-events:none}.choice[data-type="radio"]::before{border-radius:50%}.choice input:checked+span{color:#0f1a3a}
    #genderChoices .choice::before,#kontextChoices .choice::before,#massnahmeChoices .choice::before,#vollmachtChoices .choice::before,#zusatzChoices .choice::before{display:none}
    #genderChoices .choice.is-active,#genderChoices .choice:has(input:checked),#kontextChoices .choice:has(input:checked),#kontextChoices .choice.is-active,#massnahmeChoices .choice:has(input:checked),#massnahmeChoices .choice.is-active,#vollmachtChoices .choice:has(input:checked),#vollmachtChoices .choice.is-active,#zusatzChoices .choice:has(input:checked),#zusatzChoices .choice.is-active{background:rgba(18,184,134,.20);border-color:var(--good);box-shadow:0 0 0 2px rgba(18,184,134,.25)}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Einwilligungsfähigkeit (Maßnahmenbezogen)</h1>
      <p class="note">Modul zur strukturierten Prüfung und Dokumentation der Einwilligungsfähigkeit im klinischen Alltag. Bewertet die Domänen Verstehen, Erinnern, Abwägen und Willensmitteilung nach gängigen Kriterien (§ 630d BGB). Quellen sind unten verlinkt.</p>
      <div class="row" style="margin-top:6px">
        <div>
          <label>Geschlecht der/des Proband*in</label>
          <div class="choices" id="genderChoices">
            <label class="choice" data-type="radio"><input type="radio" name="geschlecht" value="m"><span>männlich</span></label>
            <label class="choice" data-type="radio"><input type="radio" name="geschlecht" value="w"><span>weiblich</span></label>
            <label class="choice" data-type="radio"><input type="radio" name="geschlecht" value="d" checked><span>divers / neutral</span></label>
          </div>
        </div>
        <div>
          <label for="patient">Patient*in (optional)</label>
          <input id="patient" type="text" placeholder="Initialen / Fall-ID" />
        </div>
      </div>
      <div class="row" style="margin-top:16px">
        <div>
          <label>Konkrete Maßnahme / Entscheidung</label>
          <div class="choices twocol" id="massnahmeChoices">
            <label class="choice"><input type="checkbox" name="massnahmeOpt" value="Behandlung auf freiwilliger Basis"><span>Behandlung auf freiwilliger Basis</span></label>
            <label class="choice"><input type="checkbox" name="massnahmeOpt" value="Psychopharmakologische Therapie"><span>Psychopharmakologische Therapie</span></label>
            <label class="choice"><input type="checkbox" name="massnahmeOpt" value="Elektrokrampftherapie (EKT)"><span>Elektrokrampftherapie (EKT)</span></label>
            <label class="choice"><input type="checkbox" name="massnahmeOpt" value="Operativer Eingriff"><span>Operativer Eingriff</span></label>
            <label class="choice"><input type="checkbox" name="massnahmeOpt" value="Medizinische Untersuchungen"><span>Medizinische Untersuchungen</span></label>
            <label class="choice"><input type="checkbox" name="massnahmeOpt" value="custom" id="massnahmeCustom"><span>Andere / Freitext</span></label>
          </div>
          <input id="massnahmeFree" type="text" placeholder="Freitext Maßnahme oder Ergänzungen …" style="margin-top:8px;display:block" />
        </div>
        <div class="row" style="grid-template-columns:1fr 1fr;gap:12px;margin-top:0">
          <div><label for="zeitpunktDatum">Datum</label><input id="zeitpunktDatum" type="date" /></div>
          <div><label for="zeitpunktZeit">Uhrzeit</label><input id="zeitpunktZeit" type="time" style="display:none" /><div id="zeitSelects" style="display:flex;gap:8px"><select id="zeitStd"></select><select id="zeitMin"></select></div></div>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>Vollmacht / Rechtliche*r Betreuer*in</label>
          <div class="choices twocol" id="vollmachtChoices">
            <label class="choice"><input type="checkbox" id="vmKeine" value="keine"><span>keine</span></label>
            <label class="choice"><input type="checkbox" id="vmUnklar" value="unklar"><span>unklar</span></label>
          </div>
          <input id="vollmachtName" type="text" placeholder="Name der bevollmächtigten Person / Betreuer*in (falls vorhanden)" style="margin-top:8px" />
        </div>
      </div>
      <div style="margin-top:16px">
        <label>Kontext / Aufklärung</label>
        <div class="choices" id="kontextChoices">
          <label class="choice"><input type="checkbox" value="Aufklärung wurde durch Facharzt durchgeführt. Nutzen, Risiken, Alternativen wurden ausführlich erläutert. Alle Rückfragen wurden beantwortet."><span>FA</span></label>
          <label class="choice"><input type="checkbox" value="Aufklärung wurde durch Assistenzarzt durchgeführt. Nutzen, Risiken, Alternativen wurden ausführlich erläutert. Alle Rückfragen wurden beantwortet."><span>AÄ</span></label>    
          <label class="choice"><input type="checkbox" value="Aufklärung abgelehnt / nicht möglich (z. B. Intox/Delir) – erneute Aufklärung geplant."><span>Aufklärung nicht möglich</span></label>
          <label class="choice"><input type="checkbox" value="custom" id="kontextCustom"><span>Andere / Freitext</span></label>
        </div>
        <input id="kontext" type="text" placeholder="Freitext (optional)" style="margin-top:8px;display:none" />
      </div>
      <div class="row" style="margin-top:16px">
        <div>
          <label>Zusatzfaktoren</label>
          <div class="choices" id="zusatzChoices">
            <label class="choice"><input type="checkbox" id="akut" value="akut"><span>akute Beeinträchtigung plausibel (z. B. Delir, Intox, floride Psychose)</span></label>
            <label class="choice"><input type="checkbox" id="druck" value="keinDruck" checked><span>kein äußerer Druck/keine unzulässige Beeinflussung erkennbar</span></label>
          </div>
          <input id="zusatzFree" type="text" placeholder="Freitext (optional)" style="margin-top:8px" />
        </div>
      </div>
    </div>

    <div class="grid">
      <div id="cardV" class="card neon pending">

        <h2>1) Verstehen (Sachverhalt & Maßnahme)</h2>
        <div class="slider-wrap" data-q="v1"><div class="slider-header"><label>Kann die Person Grund der Behandlung & Ziel adäquat wiedergeben?</label><span class="slider-val" id="v1Val">—</span></div><input type="range" min="-1" max="2" step="1" value="-1" /><div class="ticks"><span>−1 nicht beurteilbar</span><span>0 inadäquat</span><span>1 teilweise</span><span>2 adäquat</span></div></div>
        <div class="slider-wrap" data-q="v2"><div class="slider-header"><label>Kennt die Person wesentliche Risiken & Alternativen?</label><span class="slider-val" id="v2Val">—</span></div><input type="range" min="-1" max="2" step="1" value="-1" /><div class="ticks"><span>−1 nicht beurteilbar</span><span>0 inadäquat</span><span>1 teilweise</span><span>2 adäquat</span></div></div>
      <button type="button" class="collapsible"><u><i>Hinweis</i></u></button>
<div class="content1">
  <p class=ticks1><i>Inadäquat (0): versteht Maßnahme oder Zweck nicht bzw. verwechselt Inhalte.</br>teilweise (1): erkennt Grundidee, aber Details oder Risiken fehlen.</br>adäquat (2): kann Zweck, Ablauf und wesentliche Risiken in eigenen Worten korrekt wiedergeben.</i></p>
</div>
      </div>
      <div id="cardE" class="card neon pending">

        <h2>2) Erinnern (Information behalten)</h2>
        <div class="slider-wrap" data-q="e1"><div class="slider-header"><label>Gibt die Person die Aufklärung konsistent in eigenen Worten wieder?</label><span class="slider-val" id="e1Val">—</span></div><input type="range" min="-1" max="2" step="1" value="-1" /><div class="ticks"><span>−1 nicht beurteilbar</span><span>0 inadäquat</span><span>1 teilweise</span><span>2 adäquat</span></div></div>
        <div class="slider-wrap" data-q="e2"><div class="slider-header"><label>Bleibt die Darstellung nach kurzer Ablenkung konsistent?</label><span class="slider-val" id="e2Val">—</span></div><input type="range" min="-1" max="2" step="1" value="-1" /><div class="ticks"><span>−1 nicht beurteilbar</span><span>0 inadäquat</span><span>1 teilweise</span><span>2 adäquat</span></div></div>
         <button type="button" class="collapsible"><u><i>Hinweis</i></u></button>
          <div class="content1">
           <p class=ticks1><i>Inadäquat (0): kann nach kurzer Zeit nichts oder Falsches wiedergeben.</br> Teilweise (1): erinnert Kernaussagen, aber unvollständig oder unsicher.</br> Adäquat (2): gibt Aufklärung konsistent, eigenständig und stabil wieder.</i></p>
          </div>      
      </div>
      <div id="cardA" class="card neon pending">

        <h2>3) Abwägen (Nutzen/Risiken, Wertebezug)</h2>
        <div class="slider-wrap" data-q="a1"><div class="slider-header"><label>Vergleicht die Person Vor‑/Nachteile und begründet die Wahl?</label><span class="slider-val" id="a1Val">—</span></div><input type="range" min="-1" max="2" step="1" value="-1" /><div class="ticks"><span>−1 nicht beurteilbar</span><span>0 inadäquat</span><span>1 teilweise</span><span>2 adäquat</span></div></div>
        <div class="slider-wrap" data-q="a2"><div class="slider-header"><label>Begründung frei von eindeutig pathologisch verzerrten Motiven?</label><span class="slider-val" id="a2Val">—</span></div><input type="range" min="-1" max="2" step="1" value="-1" /><div class="ticks"><span>−1 nicht beurteilbar</span><span>0 inadäquat</span><span>1 teilweise</span><span>2 adäquat</span></div></div>
          <button type="button" class="collapsible"><u><i>Hinweis</i></u></button>  
           <div class="content1"> <p class=ticks1><i>Inadäquat (0): keine erkennbare Abwägung, stark verzerrte Begründung.</br>Teilweise (1): erkennt Vor-/Nachteile, aber Entscheidung wirkt impulsiv oder fremdbestimmt.</br>Adäquat (2): reflektiert Nutzen, Risiken und Alternativen nachvollziehbar und wertekonform.</i></i></p>
            </div> 
      </div>

      <div id="cardM" class="card neon pending">
        <h2>4) Willensmitteilung (konstant & verständlich)</h2>
        <div class="slider-wrap" data-q="m1"><div class="slider-header"><label>Ist eine klare Zustimmung/Ablehnung möglich?</label><span class="slider-val" id="m1Val">—</span></div><input type="range" min="-1" max="2" step="1" value="-1" /><div class="ticks"><span>−1 nicht beurteilbar</span><span>0 inadäquat</span><span>1 teilweise</span><span>2 adäquat</span></div></div>
        <div class="slider-wrap" data-q="m2"><div class="slider-header"><label>Ist die Entscheidung nach kurzer Zeit stabil?</label><span class="slider-val" id="m2Val">—</span></div><input type="range" min="-1" max="2" step="1" value="-1" /><div class="ticks"><span>−1 nicht beurteilbar</span><span>0 inadäquat</span><span>1 teilweise</span><span>2 adäquat</span></div></div>
         <button type="button" class="collapsible"><u><i>Hinweis</i></u></button>  
           <div class="content1"> <p class=ticks1><i>Inadäquat (0): keine klare oder wechselnde Zustimmung/Ablehnung.</br>Teilweise (1): Willensäußerung vorhanden, aber instabil oder widersprüchlich.</br>Adäquat (2): klarer, konstanter, verständlich formulierter Wille.</i></p>
            </div>
      </div>
    </div>

    <div class="card"><h2>Aktionen</h2><div class="actions"><button class="primary" id="bewerten" data-testid="btn-generate">Bewerten & Textbaustein erzeugen</button><button class="secondary" id="kopieren" data-testid="btn-copy">Text kopieren</button><button class="secondary" id="reload" data-testid="btn-reload">Reload</button></div></div>

    <div class="card">
      <h2>Ergebnis</h2>
      <p id="scoreLine" class="note">Noch keine Bewertung.</p>
      <div id="statusBadge" class="badge unknown">–</div>
      <div id="friendly" class="friendly" aria-live="polite"></div>
      <h2 style="margin-top:14px">Textbaustein für die EPA/SAP</h2>
      <textarea id="befund" placeholder="Hier erscheint der generierte Befund …" data-testid="output"></textarea>
      <p class="footer"><strong>Informationsquellen / Referenzen:</strong>
        <a href="https://www.gesetze-im-internet.de/bgb/__630d.html" target="_blank" rel="noopener">§ 630d BGB (Einwilligung)</a> ·
        <a href="https://www.gesetze-im-internet.de/bgb/__104.html" target="_blank" rel="noopener">§ 104 BGB (Geschäftsunfähigkeit)</a> ·
        <a href="https://www.lexikon-betreuungsrecht.de/Einwilligungsfähigkeit" target="_blank" rel="noopener">Lexikon Betreuungsrecht: Einwilligungsfähigkeit</a>
      </p>
    </div>

    <div class="card"><details><summary>Interner Selbsttest (öffnet Details)</summary><div id="testOut" class="tests"></div></details></div>

    <footer class="app-footer" role="contentinfo" aria-label="Rechtlicher Hinweis"><strong>Rechtlicher Hinweis:</strong><br>Dieses Tool dient ausschließlich der ärztlichen Dokumentationsunterstützung
  und ersetzt keine persönliche Beurteilung der Einwilligungsfähigkeit.
  Es speichert keine personenbezogenen Daten und arbeitet lokal im Browser.
  </footer>
    <div class="signature">© 2025 Andrii Rianov – alle Rechte vorbehalten. Bremen 2025</div>
  </div>

  <script>
    
var coll = document.getElementsByClassName("collapsible");
var i;

for (i = 0; i < coll.length; i++) {
  coll[i].addEventListener("click", function() {
    this.classList.toggle("active");
    var content = this.nextElementSibling;
    if (content.style.display === "block") {
      content.style.display = "none";
    } else {
      content.style.display = "block";
    }
  });
}
    function G(){const gEl=document.querySelector('input[name="geschlecht"]:checked');const g=gEl?gEl.value:'d';if(g==='m')return{subj:'Der Patient',obj:'den Patienten',poss:'sein',refl:'ihm',persN:'er',persA:'ihn'};if(g==='w')return{subj:'Die Patientin',obj:'die Patientin',poss:'ihr',refl:'ihr',persN:'sie',persA:'sie'};return{subj:'Die betroffene Person',obj:'die betroffene Person',poss:'der betroffenen Person',refl:'der betroffenen Person',persN:'die betroffene Person',persA:'die betroffene Person'}}
    const doms={V:['v1','v2'],E:['e1','e2'],A:['a1','a2'],M:['m1','m2']};
    function readSlider(name){const wrap=document.querySelector(`.slider-wrap[data-q="${name}"]`);if(!wrap)return null;const val=parseInt(wrap.querySelector('input[type=range]').value,10);return isNaN(val)?null:val}
    function domainStats(keys){const vals=keys.map(readSlider).filter(v=>v!==null);if(!vals.length)return{sum:null,min:null,nb:true,answered:false};const includesNB=vals.includes(-1);return{sum:vals.reduce((a,b)=>a+b,0),min:Math.min(...vals),nb:includesNB,answered:vals.length===keys.length&&!includesNB}}
    function classify(res){const mins=Object.values(res).map(d=>d.min);const nInad=mins.filter(m=>m===0).length;const nHigh=Object.values(res).filter(d=>(d.sum!==null&&d.sum>=3)).length;const anyNB=Object.values(res).some(d=>d.nb===true);const sums=Object.values(res).map(d=>d.sum).filter(s=>s!==null);if(sums.length<4)return{label:'Nicht beurteilbar',code:'NB',badge:'unknown'};const total=sums.reduce((a,b)=>a+b,0);if(anyNB)return{label:'Nicht beurteilbar',code:'NB',badge:'unknown',total};if(nInad>=2||total<4)return{label:'Nicht einwilligungsfähig',code:'NEF',badge:'bad',total};if(nInad===0&&nHigh>=2&&total>=7)return{label:'Einwilligungsfähig',code:'EF',badge:'ok',total};return{label:'Eingeschränkt / vorauss. nicht ausreichend',code:'EE',badge:'warn',total}}
    function domLabel(k){return{V:'Verstehen',E:'Erinnern',A:'Abwägen',M:'Willensmitteilung'}[k]}function mapWord(m){return({0:'inadäquat',1:'teilweise',2:'adäquat',[-1]:'nicht beurteilbar'})[m]}
    function neonUpdate(){const cards={V:'cardV',E:'cardE',A:'cardA',M:'cardM'};Object.entries(cards).forEach(([k,id])=>{const d=domainStats(doms[k]);const el=document.getElementById(id);el.classList.remove('ready','pending');el.classList.add(d.answered?'ready':'pending')})}
    function humanMessage(c){const map={EF:'Ergebnis: einwilligungsfähig. Die Person hat Verständnis, kann erinnern, abwägen und den Willen stabil mitteilen. Die Einwilligung kann eigenständig erfolgen.',EE:'Ergebnis: eingeschränkt. Hinweise auf Lücken in Verständnis/Abwägung/Stabilität. Bitte engmaschig erneut prüfen; ggf. Vertreter*in/Betreuung erwägen.',NEF:'Ergebnis: nicht einwilligungsfähig. Einwilligung durch Vertreter*in/Betreuung bzw. ggf. gerichtliche Genehmigung erforderlich.',NB:'Ergebnis: nicht beurteilbar. Datenlage unvollständig oder Bewertung derzeit nicht möglich (z. B. NB‑Angaben) – erneute Prüfung nach Stabilisierung.'};return map[c.code]||''}
    function selectedMassnahme(){const checked=Array.from(document.querySelectorAll('#massnahmeChoices input[name="massnahmeOpt"]:checked'));const values=checked.map(i=>i.value).filter(v=>v!=='custom');const add=(document.getElementById('massnahmeFree').value||'').trim();const customOn=checked.some(i=>i.value==='custom');let base=values.join('; ');if(customOn&&add)base=base?`${base}; ${add}`:add;else if(add)base=base?`${base} – Ergänzung: ${add}`:add;return base}
    function generateText(){const res={V:domainStats(doms.V),E:domainStats(doms.E),A:domainStats(doms.A),M:domainStats(doms.M)};let cls=classify(res);const pat=(document.getElementById('patient').value||'—').trim();const mass=(selectedMassnahme()||'(Maßnahme nicht angegeben)').trim();const dVal=document.getElementById('zeitpunktDatum').value;let tVal='';const native=document.getElementById('zeitpunktZeit');if(native&&native.style.display!=='none'&&native.value){tVal=native.value}else{const hs=document.getElementById('zeitStd');const ms=document.getElementById('zeitMin');if(hs&&ms&&hs.value!==''&&ms.value!=='')tVal=`${hs.value}:${ms.value}`}
      const ts=(dVal||tVal)?`${dVal||new Date().toLocaleDateString('de-DE')} ${tVal||new Date().toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'})}`:new Date().toLocaleString('de-DE');
      const ctxChecked=Array.from(document.querySelectorAll('#kontextChoices input[type=checkbox]:checked')).map(i=>i.value);const customChecked=ctxChecked.includes('custom');const custom=document.getElementById('kontext').value.trim();const ctxList=ctxChecked.filter(v=>v!=='custom');const ktx=(customChecked?(custom?custom:null):null)||(ctxList.length?ctxList.join(' '):'—');
      const akut=document.getElementById('akut').checked;const druck=document.getElementById('druck').checked;const g=G();
      if(akut&&cls.code==='EF'){cls={...cls,code:'EE',label:'Eingeschränkt / vorauss. nicht ausreichend',badge:'warn'}}
      const badge=document.getElementById('statusBadge');badge.className=`badge ${cls.badge}`;badge.textContent=cls.code;const sums=['V','E','A','M'].map(k=>`${k}:${res[k].sum??'–'}`).join(' ');document.getElementById('scoreLine').textContent=`Gesamtscore: ${typeof cls.total==='number'?cls.total:'–'} | ${sums}`;document.getElementById('friendly').textContent=humanMessage(cls);
      function domSentence(key,d){const base=`${domLabel(key)}`;if(d.sum===null)return`${g.subj} wurde in der Domäne „${base}” nicht hinreichend erhoben.`;const qual=mapWord(d.min);if(key==='V')return`${g.subj} kann den Grund der Behandlung und das Ziel ${qual} wiedergeben (Summe ${d.sum}).`;if(key==='E')return`${g.subj} kann die vermittelten Informationen ${qual} behalten und konsistent wiedergeben (Summe ${d.sum}).`;if(key==='A')return`${g.subj} vergleicht Nutzen und Risiken ${qual} und begründet die Entscheidung entsprechend (Summe ${d.sum}).`;return`${g.subj} kann den eigenen Willen ${qual} mitteilen und zeigt eine entsprechend stabile Entscheidung (Summe ${d.sum}).`}
      const domTxt=['V','E','A','M'].map(k=>`- ${domSentence(k,res[k])}`).join('\n');
      const zusatzTxt=(document.getElementById('zusatzFree')?.value||'').trim();const zParts=[];if(akut)zParts.push('Hinweise auf eine akute Beeinträchtigung');if(druck)zParts.push('kein äußerer Druck erkennbar');if(zusatzTxt)zParts.push(`Freitext: ${zusatzTxt}`);const zf=zParts.length?`Zusatzfaktoren: ${zParts.join('; ')}`:'';
      let schluss; if(cls.code==='EF'){schluss=`${g.subj} gilt im Hinblick auf die konkrete Maßnahme als einwilligungsfähig.`} else if(cls.code==='EE'){schluss=`Die Einwilligungsfähigkeit von ${g.obj} erscheint eingeschränkt und voraussichtlich nicht ausreichend; die Einbindung einer Vertreterin/eines Vertreters bzw. einer Betreuerin/eines Betreuers ist zu prüfen.`} else if(cls.code==='NEF'){schluss=`Im Hinblick auf die konkrete Maßnahme ist ${g.subj} nicht einwilligungsfähig; erforderlich ist die Einwilligung durch eine Vertreterin/einen Vertreter bzw. ggf. eine gerichtliche Genehmigung.`} else {schluss=`Die Einwilligungsfähigkeit ist aktuell nicht verlässlich beurteilbar; eine erneute Prüfung nach Stabilisierung bzw. erneuter Aufklärung ist erforderlich.`}
      const header=`Einwilligungsfähigkeit – Prüfvermerk (maßnahmebezogen)\nZeitpunkt: ${ts}\n`+(pat!=='—'?`Proband*in: ${pat}\n`:``)+`Maßnahme/Entscheidung: ${mass}\n`+(ktx!=='—'?`Kontext/Aufklärung: ${ktx}\n`:``)+(function(){const vmKeine=document.getElementById('vmKeine').checked;const vmUnklar=document.getElementById('vmUnklar').checked;const vmName=(document.getElementById('vollmachtName').value||'').trim();if(vmKeine)return`Vollmacht/Betreuung: keine Angaben zu einer bevollmächtigten oder betreuenden Person.\n`;if(vmUnklar)return`Vollmacht/Betreuung: unklar; Prüfung/Erhebung veranlasst.\n`;return vmName?`Vollmacht/Betreuung: ${vmName}\n`:''})();
      const text=`${header}\nDomänenbewertung (−1 nicht beurteilbar / 0 inadäquat / 1 teilweise / 2 adäquat):\n${domTxt}\n\nGesamtscore: ${typeof cls.total==='number'?cls.total:'–'}. Ergebnis: ${cls.label}.\n${zf?zf+"\n":''}Schlussfolgerung: ${schluss}\n\nRechtsgrundlage und Referenzen: § 630d BGB; Maßnahme‑ und entscheidungsbezogene Einwilligungsfähigkeit gemäß Rechtsprechung; konzeptionelle Orientierung an etablierten fachlichen Kriterien (Verstehen, Erinnern, Abwägen, Mitteilung des Willens).`;
      document.getElementById('befund').value=text}
    function resetForm(){const gDefault=document.querySelector('input[name="geschlecht"][value="d"]');if(gDefault)gDefault.checked=true;updateChipsActive('#genderChoices');document.querySelectorAll('#massnahmeChoices input[type=checkbox]').forEach(r=>r.checked=false);const mCustom=document.getElementById('massnahmeCustom');if(mCustom)mCustom.checked=false;document.getElementById('massnahmeFree').value='';updateChipsActive('#massnahmeChoices');document.getElementById('patient').value='';document.getElementById('zeitpunktDatum').value='';const native=document.getElementById('zeitpunktZeit');if(native)native.value='';const hs=document.getElementById('zeitStd');const ms=document.getElementById('zeitMin');if(hs)hs.value='00';if(ms)ms.value='00';document.querySelectorAll('#kontextChoices input[type=checkbox]').forEach(c=>c.checked=false);document.getElementById('kontext').value='';document.getElementById('kontext').style.display='none';updateChipsActive('#kontextChoices');document.getElementById('akut').checked=false;document.getElementById('druck').checked=true;document.querySelectorAll('.slider-wrap input[type=range]').forEach(r=>{r.value=-1});document.querySelectorAll('.slider-val').forEach(el=>{el.textContent='—'});document.getElementById('statusBadge').className='badge unknown';document.getElementById('statusBadge').textContent='–';document.getElementById('scoreLine').textContent='Noch keine Bewertung.';document.getElementById('friendly').textContent='';document.getElementById('befund').value='';const zfree=document.getElementById('zusatzFree');if(zfree)zfree.value='';document.getElementById('vmKeine').checked=false;document.getElementById('vmUnklar').checked=false;document.getElementById('vollmachtName').value='';updateChipsActive('#vollmachtChoices');updateChipsActive('#zusatzChoices');neonUpdate()}
    function labelFor(v){return({[-1]:'nicht beurteilbar',0:'inadäquat',1:'teilweise',2:'adäquat'})[v]}
    function enhanceSlider(input){input.addEventListener('click',(ev)=>{const rect=input.getBoundingClientRect();const ratio=Math.min(1,Math.max(0,(ev.clientX-rect.left)/rect.width));const min=parseInt(input.min,10),max=parseInt(input.max,10),step=parseInt(input.step,10)||1;const raw=min+ratio*(max-min);const snapped=Math.round(raw/step)*step;input.value=Math.max(min,Math.min(max,snapped));input.dispatchEvent(new Event('input',{bubbles:true}));input.dispatchEvent(new Event('change',{bubbles:true}))})}
    document.querySelectorAll('.slider-wrap').forEach(w=>{const q=w.getAttribute('data-q');const input=w.querySelector('input[type=range]');enhanceSlider(input);const out=document.getElementById(q+'Val');const set=()=>{const v=parseInt(input.value,10);out.textContent=labelFor(v);neonUpdate()};input.addEventListener('input',set);input.addEventListener('change',set);set();const ticks=w.querySelectorAll('.ticks span');if(ticks.length===4){ticks[0].textContent='−1 nicht beurteilbar';ticks[1].textContent='0 inadäquat';ticks[2].textContent='1 teilweise';ticks[3].textContent='2 adäquat'}})
    document.getElementById('bewerten').addEventListener('click',generateText);
    document.getElementById('kopieren').addEventListener('click',async(ev)=>{const btn=ev.currentTarget;const ta=document.getElementById('befund');try{if(navigator.clipboard&&window.isSecureContext){await navigator.clipboard.writeText(ta.value)}else{ta.select();ta.setSelectionRange(0,99999);document.execCommand('copy')}const old=btn.textContent;btn.textContent='Kopiert!';setTimeout(()=>{btn.textContent=old},1200)}catch(e){alert('Kopieren nicht möglich. Bitte Text manuell markieren.')}})
    document.getElementById('reload').addEventListener('click',resetForm);
    const customBox=document.getElementById('kontextCustom');if(customBox){customBox.addEventListener('change',(e)=>{const free=document.getElementById('kontext');const on=e.target.checked;free.style.display=on?'block':'none';if(!on)free.value='';updateChipsActive('#kontextChoices')})}
    const mCustom=document.getElementById('massnahmeCustom');if(mCustom){mCustom.addEventListener('change',()=>{})}
    function updateChipsActive(rootSel){document.querySelectorAll(`${rootSel} .choice`).forEach(lbl=>{const inp=lbl.querySelector('input');if(!inp)return;lbl.classList.toggle('is-active',inp.checked)})}
    document.querySelectorAll('#genderChoices input[type=radio], #massnahmeChoices input[type=checkbox], #kontextChoices input[type=checkbox], #vollmachtChoices input[type=checkbox], #zusatzChoices input[type=checkbox]').forEach(inp=>inp.addEventListener('change',()=>{updateChipsActive('#genderChoices');updateChipsActive('#massnahmeChoices');updateChipsActive('#kontextChoices');updateChipsActive('#vollmachtChoices');updateChipsActive('#zusatzChoices')}))
    ;(function initTime(){const time=document.createElement('input');time.setAttribute('type','time');const supports=time.type==='time';const native=document.getElementById('zeitpunktZeit');const selects=document.getElementById('zeitSelects');if(supports){native.style.display='block';selects.style.display='none'}else{native.style.display='none';selects.style.display='flex'}const std=document.getElementById('zeitStd');const min=document.getElementById('zeitMin');if(std&&std.options.length===0){for(let h=0;h<24;h++){const v=String(h).padStart(2,'0');const opt=document.createElement('option');opt.value=v;opt.textContent=v;std.appendChild(opt)}}if(min&&min.options.length===0){for(let m=0;m<60;m+=5){const v=String(m).padStart(2,'0');const opt=document.createElement('option');opt.value=v;opt.textContent=v;min.appendChild(opt)}}const now=new Date();const hh=String(now.getHours()).padStart(2,'0');const mm=String(Math.round(now.getMinutes()/5)*5%60).padStart(2,'0');if(std)std.value=hh;if(min)min.value=mm})();
    ;(function initDate(){const d=document.getElementById('zeitpunktDatum');if(d&&!d.value){const now=new Date();const yyyy=now.getFullYear();const mm=String(now.getMonth()+1).padStart(2,'0');const dd=String(now.getDate()).padStart(2,'0');d.value=`${yyyy}-${mm}-${dd}`}})();
    ;(function initVollmacht(){const none=document.getElementById('vmKeine');const unk=document.getElementById('vmUnklar');const name=document.getElementById('vollmachtName');function sync(){const any=(none&&none.checked)||(unk&&unk.checked);if(name){name.disabled=any;name.placeholder=any?'— (deaktiviert)':'Name der bevollmächtigten Person / Betreuer*in (falls vorhanden)';if(any)name.value=''}updateChipsActive('#vollmachtChoices')}if(none){none.addEventListener('change',()=>{if(none.checked&&unk)unk.checked=false;sync()})}if(unk){unk.addEventListener('change',()=>{if(unk.checked&&none)none.checked=false;sync()})}if(name){name.addEventListener('input',()=>{if(name.value.trim().length>0){if(none)none.checked=false;if(unk)unk.checked=false;updateChipsActive('#vollmachtChoices')}})}sync()})();
    ;(function runSelfTests(){const out=document.getElementById('testOut');if(!out)return;const saveVals={};['v1','v2','e1','e2','a1','a2','m1','m2'].forEach(q=>{const el=document.querySelector(`.slider-wrap[data-q="${q}"] input[type=range]`);if(el)saveVals[q]=el.value});function setVals(map){Object.entries(map).forEach(([q,v])=>{const el=document.querySelector(`.slider-wrap[data-q="${q}"] input[type=range]`);if(el){el.value=String(v);el.dispatchEvent(new Event('input',{bubbles:true}))}})}function getCls(){const res={V:domainStats(doms.V),E:domainStats(doms.E),A:domainStats(doms.A),M:domainStats(doms.M)};return classify(res).code}const tests=[];setVals({v1:-1,v2:-1,e1:-1,e2:-1,a1:-1,a2:-1,m1:-1,m2:-1});tests.push(['Alle NB → NB',getCls()==='NB']);setVals({v1:2,v2:2,e1:2,e2:2,a1:2,a2:1,m1:2,m2:1});tests.push(['Hochwerte → EF',getCls()==='EF']);setVals({v1:0,v2:0,e1:0,e2:0,a1:2,a2:2,m1:2,m2:2});tests.push(['≥2 inadäquat → NEF',getCls()==='NEF']);setVals({v1:1,v2:1,e1:1,e2:1,a1:1,a2:1,m1:1,m2:1});tests.push(['Mittelwerte → EE',getCls()==='EE']);const akutBox=document.getElementById('akut');const prevAkut=akutBox?akutBox.checked:false;if(akutBox)akutBox.checked=true;setVals({v1:2,v2:2,e1:2,e2:2,a1:2,a2:1,m1:2,m2:1});const baseCode=getCls();const enforced=(akutBox&&akutBox.checked&&baseCode==='EF')?'EE':baseCode;tests.push(['Akut verhindert EF',enforced!=='EF']);if(akutBox)akutBox.checked=prevAkut;out.textContent=tests.map(([n,ok],i)=>`${i+1}. ${ok?'PASS ✅':'FAIL ❌'} – ${n}`).join('\n');setVals(saveVals)})();
    updateChipsActive('#genderChoices');updateChipsActive('#massnahmeChoices');updateChipsActive('#kontextChoices');updateChipsActive('#vollmachtChoices');updateChipsActive('#zusatzChoices');neonUpdate();
  </script>
         
